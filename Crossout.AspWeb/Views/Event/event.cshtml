@{
    Layout = "_Layout";
}

@using Crossout.Model.Items
@using Crossout.Web
@using Crossout.AspWeb.Models
@using Crossout.Data.KnightRiders
@using System.Globalization
@model Crossout.AspWeb.Models.General.KnightRidersModel

<partial name="header" model="@Model" />
<partial name="status" model="@Model.Status" />

<div class="half-hd-container">

    <div class="row justify-content-center px-2">
        <img class="img-fluid" src="https://cdn.cloudflare.steamstatic.com/steamcommunity/public/images/clans/26076615/2a9c25f1a5cb2f0387d52b6093d8275835307b1c.jpg" />
    </div>

    @*<div class="row">
        <div class="col-md-6 col-sm-12 d-flex flex-row align-items-center justify-content-center">
            <div class="m-2">
                Buy Ingredients for:
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-radio-prices" id="buyResorucesForSell">Sell Price</button>
                    <button class="btn btn-outline-secondary btn-radio-prices active" id="buyResorucesForBuy">Buy Price</button>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-sm-12 d-flex flex-row align-items-center justify-content-center">
            <div class="m-2">
                Sell Item for:
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-radio-prices active" id="sellItemForSell">Sell Price</button>
                    <button class="btn btn-outline-secondary btn-radio-prices" id="sellItemForBuy">Buy Price</button>
                </div>
            </div>
        </div>
    </div>*@

    <div class="row" id="itemWrapper">
        @foreach (EventItem item in Model.EventItems)
        {
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 item-container" data-profit="-999">
                <div class="card p-2 my-2">
                    <div class="d-flex flex-row justify-content-between">
                        <div class="d-flex flex-row align-items-center">
                            <div class="mr-1">
                                @if (item.Id != null)
                                {
                                    @if (item.ImageOverridePath != null)
                                    {
                                        <a href="~/item/@(item.Id)"><img class="item-image-search" src="@(item.ImageOverridePath)" /></a>
                                    }
                                    else if (Model.ContainedItems[(int)item.Id].ImageExists)
                                    {
                                        <a href="~/item/@(item.Id)"><img class="item-image-search" src="~/img/items/@(item.Id).png" /></a>
                                    }
                                    else
                                    {
                                        <a href="~/item/@(item.Id)"><img class="item-image-search" src="~/img/NoImage.png" /></a>
                                    }
                                }
                                else
                                {
                                    @if (item.ImageOverridePath != null)
                                    {
                                        <img class="item-image-search" src="@(item.ImageOverridePath)" />
                                    }
                                    else
                                    {
                                        <img class="item-image-search" src="~/img/event/@(item.Key).png" />
                                    }
                                }
                            </div>

                            <div>
                                @if (item.Id != null)
                                {
                                    <a href="~/item/@(item.Id)">@item.Name</a>
                                }
                                else
                                {
                                    @item.Name
                                }
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm content-button pull-right" id="@(item.Key)">Show Ingredients</button>
                        </div>
                    </div>

                    <div id="content-wrapper-@(item.Key)" style="display: none; margin-bottom: 8px; margin-right: 8px">
                        <table class="table table-borderless table-compact">
                            <thead>
                                <tr>
                                    <th>
                                        Item
                                    </th>
                                    <th>
                                        Amount
                                    </th>
                                    <th>
                                        Sell Price
                                    </th>
                                    <th>
                                        Buy Price
                                    </th>
                                </tr>
                            </thead>
                            @foreach (Ingredient ingredient in item.Ingredients)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex flex-row align-items-center my-1">
                                            @if (Model.ContainedItems[(int)ingredient.Id].ImageExists)
                                            {
                                                <a href="~/item/@(ingredient.Id)"><img class="item-image-med" src="~/img/items/@(ingredient.Id).png" /></a>
                                            }
                                            else
                                            {
                                                <a href="~/item/@(ingredient.Id)"><img class="item-image-med" src="~/img/NoImage.png" /></a>
                                            }
                                            <a href="~/item/@(ingredient.Id)"><span class="ml-1">@ingredient.Name</span></a>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        x @ingredient.Amount
                                    </td>
                                    <td class="align-middle">
                                        <div>@(ingredient.FormatSellPrice) <img src="~/img/Coin.png" height="14" /></div>
                                    </td>
                                    <td class="align-middle">
                                        <div>@(ingredient.FormatBuyPrice) <img src="~/img/Coin.png" height="14" /></div>
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                    <table class="table table-borderless table-compact">
                        <thead>
                            <tr>
                                <th>

                                </th>
                                <th>
                                    Sell
                                </th>
                                <th>
                                    Buy
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (item.Id != null)
                            {
                                <tr>
                                    <td>Price</td>
                                    <td>
                                        @if (item.Id != null)
                                        {
                                            <span style="color: red">@item.FormatSellPrice</span> <img src="~/img/Coin.png" height="14" />
                                        }
                                        else
                                        {
                                            <span>Untradeable</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.Id != null)
                                        {
                                            <span style="color: green">@item.FormatBuyPrice</span> <img src="~/img/Coin.png" height="14" />
                                        }
                                        else
                                        {
                                            <span>Untradeable</span>
                                        }
                                    </td>
                                </tr>
                            }
                            <tr>
                                <td>Ingredient Sum</td>
                                <td>
                                    <span style="color: red">@item.FormatSellSum</span> <img src="~/img/Coin.png" height="14" />
                                </td>
                                <td>
                                    <span style="color: green">@item.FormatBuySum</span> <img src="~/img/Coin.png" height="14" />
                                </td>
                            </tr>
                            @*<tr>
                                    <td>Talers</td>
                                    <td>@item.Talers</td>
                                    <td>@item.Talers</td>
                                </tr>
                                <tr>
                                    <td>in <a href="~/item/114">Coupons x10</a>: @(item.Talers * 11 / 10)</td>
                                    <td>
                                        <span style="color: red">@((Model.ContainedItems[114].SellPrice * item.Talers * 11 / 100 / 100).ToString("0.00", CultureInfo.InvariantCulture))</span> <img src="~/img/Coin.png" height="14" />
                                    </td>
                                    <td>
                                        <span style="color: green">@((Model.ContainedItems[114].BuyPrice * item.Talers * 11 / 100 / 100).ToString("0.00", CultureInfo.InvariantCulture))</span> <img src="~/img/Coin.png" height="14" />
                                    </td>
                                </tr>*@
                            @if (item.Id != null)
                            {
                                <tr>
                                    <td><b>Profit</b>@* <i>(Coupons NOT included)</i>*@</td>
                                    @if (item.Id != null)
                                    {
                                        <td>
                                            <div class="d-flex flex-row align-items-center">
                                                <div data-sellprice="@item.SellPrice" data-buyprice="@item.BuyPrice" data-sellsum="@item.TotalSellSum" data-buysum="@item.TotalBuySum" class="profit-value mr-1">

                                                </div>
                                                <img src="~/img/Coin.png" height="14" />
                                            </div>
                                        </td>
                                    }
                                    else
                                    {
                                        <td></td>
                                    }
                                    <td></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>
    <div class="alert alert-primary" role="alert">
        <h5>Limited recipes are available on the item pages.</h5>
        <ul class="list-inline">
            <li class="list-inline-item"><a href="/item/1066"><img src="/img/items/1066.png" width="32" height="32" /> Array</a></li>
            <li class="list-inline-item"><a href="/item/1067"><img src="/img/items/1067.png" width="32" height="32" /> Array ST</a></li>
            <li class="list-inline-item"><a href="/item/1054"><img src="/img/items/1054.png" width="32" height="32" /> Summator</a></li>
            <li class="list-inline-item"><a href="/item/1358"><img src="/img/items/1358.png" width="32" height="32" /> Argument</a></li>
            <li class="list-inline-item"><a href="/item/1360"><img src="/img/items/1360.png" width="32" height="32" /> Bootstrap</a></li>
            <li class="list-inline-item"><a href="/item/1359"><img src="/img/items/1359.png" width="32" height="32" /> Destructor</a></li>
            <li class="list-inline-item"><a href="/item/1357"><img src="/img/items/1357.png" width="32" height="32" /> Parser</a></li>
        </ul>
    </div>
</div>

<script>
    $(document).ready(function () {
        calculateProfit();
        sortItems('profit', 'desc');
    });

    $('.content-button').click(function (e) {
        var content = $('#content-wrapper-' + $(this).attr('id'));
        if (content.is(":visible")) {
            $(this).text("Show Ingredients");
            content.slideUp();
        } else {
            $(this).text("Hide Ingredients");
            content.slideDown();
        }
    });

    $('.btn-radio-prices').click(function () {
        $(this).siblings('.btn-radio-prices').removeClass('active');
        $(this).addClass('active');
        calculateProfit();
        sortItems('profit', 'desc');
    })

    function calculateProfit() {
        $('.profit-value').each(function (i, e) {
            var resourcePrice = 0;
            var itemPrice = 0;
            if ($('#buyResorucesForSell').hasClass('active')) {
                resourcePrice = parseFloat(this.dataset.sellsum);
            }
            if ($('#buyResorucesForBuy').hasClass('active')) {
                resourcePrice = parseFloat(this.dataset.buysum);
            }
            if ($('#sellItemForSell').hasClass('active')) {
                itemPrice = parseFloat(this.dataset.sellprice);
            }
            if ($('#sellItemForBuy').hasClass('active')) {
                itemPrice = parseFloat(this.dataset.buyprice);
            }
            var profit = itemPrice - resourcePrice - (itemPrice * 0.1);
            profit = profit / 100;
            profit = profit.toFixed(2);
            $(e).text(profit);
            $(e).parents('.item-container').attr('data-profit', profit);
        });
    }

    function sortItems(type, order) {
        var $wrapper = $('#itemWrapper');
        $wrapper.find('.item-container').sort(function (a, b) {
            if (type === 'profit') {
                if (order === 'asc') {
                    return +a.dataset.profit - +b.dataset.profit;
                } else {
                    return +b.dataset.profit - +a.dataset.profit;
                }
            }
        }).appendTo($wrapper);
    }
</script>