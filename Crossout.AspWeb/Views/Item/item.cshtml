@using System.Collections.Generic
@using System.Linq
@using Crossout.Model.Recipes
@using Crossout.Web
@using Crossout.AspWeb.Helper
@model Crossout.AspWeb.Models.Items.ItemModel

@{
    Layout = "_Layout";
    bool enableOldCraftingCalc = false;
    var loc = Model.Localizations;
}

<partial name="header" model="@Model" />
<partial name="status" model="@Model.Status" />

<div class="half-hd-container px-3">
    <div class="row p-2">
        <div class="card m-2 p-1 col-lg-8 col-md-12 pr-3">
            <div class="w-100 media m-1">
                <div class="align-self-start mr-3">
                    <a href="~/item/@Model.Item.Id">
                        @if (Model.Item.HighResImageExists)
                        {
                            <img class="item-image-highres" src="~/img/items-highres/@Model.Item.Image" />
                        }
                        else if (Model.Item.ImageExists)
                        {
                            <img class="item-image-big" src="~/img/items/@Model.Item.Image" />
                        }
                        else
                        {
                            <img class="item-image-big" src="~/img/NoImage.png" />
                        }
                    </a>
                </div>
                <div class="media-body align-self-start">
                    <div class="d-flex flex-row">
                        <h4 class="text-nowrap">@Model.Item.AvailableName</h4>
                    </div>
                    <div class="align-items-center d-flex flex-wrap">
                        @if (Model.Item.FactionNumber != 0)
                        {
                            <span class="badge badge-secondary my-1 mr-2 item-tag"><img src="~/img/faction-icons/@(Model.Item.FactionNumber).png" width="14" height="14" class="faction-icon-white" /> @Model.Item.Faction</span>
                        }
                        <span class="badge badge-secondary my-1 mr-2 item-tag">@Model.Item.CategoryName</span>
                        <span class="badge label-@Model.Item.RarityName my-1 mr-2 item-tag">@Model.Item.RarityName</span>
                        <span class="badge badge-secondary my-1 mr-2 item-tag">@Model.Item.TypeName</span>
                        @if (Model.Item.Craftable == 1)
                        {
                            <span class="badge badge-secondary my-1 mr-2 item-tag">Craftable</span>
                        }
                        @if (Model.Item.Removed == 1)
                        {
                            <span class="badge badge-danger my-1 mr-2 item-tag">Removed</span>
                        }
                        @if (Model.Item.Meta == 1)
                        {
                            <span class="badge badge-warning my-1 mr-2 item-tag">Meta</span>
                        }
                    </div>
                    @if (Model.OCRStatItems.Count > 0)
                    {
                        for (int i = 0; i < Model.OCRStatItems.Count; i++)
                        {
                            <div id="statsVersion@(i)" class="@(i == 0 ? "" : "d-none") stats-version">
                                <partial name="statscard" model="@Model.OCRStatItems[i]" />
                            </div>
                        }
                        @if (Model.OCRStatItems.Count > 1)
                        {
                            <select id="versionSelect" class="form-control">
                                @for (int i = 0; i < Model.OCRStatItems.Count; i++)
                                {
                                    <option value="statsVersion@(i)" class="@(i == 0 ? "selected" : "")">Version @Model.OCRStatItems[i].XoVer from @Model.OCRStatItems[i].Timestamp.ToString()</option>
                                }
                            </select>
                        }
                    }
                    else if (Model.Item.Description != null)
                    {
                        <p>@Html.Raw(Model.Item.Description.Text)</p>
                    }
                </div>
            </div>
        </div>

        <div class="m-0 p-0 col">
            <div class="row card m-2 p-2">
                <h4 class="align-self-center">Market</h4>
                <table class="table table-borderless table-sm m-2">
                        <thead>
                            <tr>
                                <th class="w-50">

                                </th>
                                <th class="w-50">

                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><b><loc model="loc" category="shared" name="tablehead.sellprice">Sell Price</loc></b></td>
                                <td>@Model.Item.FormatSellPrice <img height="14" src="~/img/Coin.png" /></td>
                            </tr>
                            <tr>
                                <td><b><loc model="loc" category="shared" name="tablehead.buyprice">Buy Price</loc></b></td>
                                <td>@Model.Item.FormatBuyPrice <img height="14" src="~/img/Coin.png" /></td>
                            </tr>
                            <tr>
                                <td><b><loc model="loc" category="shared" name="tablehead.margin">Margin</loc></b></td>
                                <td>@Model.Item.FormatMargin <img height="14" src="~/img/Coin.png" /></td>
                            </tr>
                            <tr>
                                <td><b><loc model="loc" category="shared" name="tablehead.roi">ROI</loc></b></td>
                                <td>@(Model.Item.FormatROI)%</td>
                            </tr>
                            <tr>
                                <td><b><loc model="loc" category="shared" name="tablehead.selloffers">Sell Offers</loc></b></td>
                                <td>@Model.Item.SellOffers</td>
                            </tr>
                            <tr>
                                <td><b><loc model="loc" category="shared" name="tablehead.buyorders">Buy Orders</loc></b></td>
                                <td>@Model.Item.BuyOrders</td>
                            </tr>
                            <tr>
                                <td><b><loc model="loc" category="shared" name="tablehead.demandsupply">Demand/Supply</loc></b></td>
                                <td>@(Model.Item.FormatDemandSupplyRatio)%</td>
                            </tr>
                            <tr>
                                <td><b><loc model="loc" category="shared" name="tablehead.lastupdate">Last Update</loc></b></td>
                                <td><span class="item-timestamp @(Model.Item.OlderThan(5) ? "item-older-than-5" : Model.Item.OlderThan(60) ? "item-older-than-60" : "")">@(Model.Item.LastUpdateTime)</span></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
            <div class="row card m-2 p-2">
                <h4 class="align-self-center">Synergy</h4>
                <partial name="synergycard" />
            </div>
        </div>
    </div>

    @if (WebSettings.Settings.EnableAds)
    {
        <div class="d-flex my-1 justify-content-center">
            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <ins class="adsbygoogle"
                 style="display:inline-block;width:728px;height:90px"
                 data-ad-client="ca-pub-1215488197322962"
                 data-ad-slot="4105484332"></ins>
            <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    }

</div>
<div id="itemTabsWrapper" class="half-hd-container px-3">
    <div class="card my-1">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="itemTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#chart" id="chart-tab" role="tab" aria-controls="chart" aria-selected="true"><loc model="loc" category="item" name="tab.chart">Chart</loc></a>
                </li>
                @if (Model.Recipe.Recipe.Ingredients.Count > 0)
                {
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#recipenew" id="recipenew-tab" role="tab" aria-controls="recipenew" aria-selected="false"><loc model="loc" category="item" name="tab.crafting">Crafting</loc></a>
                    </li>
                }
                @if (Model.Recipe.Recipe.Ingredients.Count > 0 && enableOldCraftingCalc)
                {
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#recipe" id="recipe-tab" role="tab" aria-controls="recipe" aria-selected="false"><loc model="loc" category="item" name="tab.crafting">Crafting</loc> <div class="badge badge-pill badge-secondary">Old</div></a>
                    </li>
                }
                @if (Model.IngredientUsage != null && Model.IngredientUsage.IngredientUsageList.Count > 0)
                {
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#ingredient" id="ingredient-tab" role="tab" aria-controls="ingredient" aria-selected="false"><loc model="loc" category="item" name="tab.usage">Usage</loc></a>
                    </li>
                }
                @if (false && Model.Item.Stats != null && Model.Item.Stats.SortedStats.Count > 0)
                {
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#stats" id="stats-tab" role="tab" aria-controls="stats" aria-selected="false"><loc model="loc" category="item" name="tab.stats">Stats</loc></a>
                    </li>
                }
                @if (Model.Changes.Changes.Count > 0)
                {
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#changes" id="changes-tab" role="tab" aria-controls="changes" aria-selected="false"><loc model="loc" category="item" name="tab.changes">Changes</loc></a>
                    </li>
                }

            </ul>
        </div>

        <div class="tab-content" id="itemTabContent">

            <div class="tab-pane show active" id="chart" aria-labelledby="chart-tab">
                <partial name="chart" model="@Model" />
            </div>

            @if (Model.Recipe.Recipe.Ingredients.Count > 0)
            {
                <div class="tab-pane" id="recipenew" aria-labelledby="recipenew-tab">
                    <partial name="craftingcalc" model="@Model.Recipe" />
                </div>
            }

            @if (Model.Recipe.Recipe.Ingredients.Count > 0 && enableOldCraftingCalc)
            {
                <div class="tab-pane" id="recipe" aria-labelledby="recipe-tab">
                    <div style="min-width: 740px">
                        <table class="table table-hover table-borderless">
                            <thead>
                                <tr>
                                    <th>
                                        Name
                                    </th>
                                    <th>
                                        Rarity
                                    </th>
                                    <th class="d-flex justify-content-between">
                                        <div class="">Number</div>
                                        <div class="">Sell Price</div>
                                    </th>
                                    <th>
                                    </th>
                                    <th class="d-flex justify-content-between">
                                        <div class="">Number</div>
                                        <div class="">Buy Price</div>
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                <partial name="recipepart" model="@Model.Recipe.Recipe" />
                            </tbody>
                        </table>
                        <div id="shopping-list-wrapper">
                            <table class="table table-hover table-borderless" id="shopping-list">
                                <thead>
                                    <tr>
                                        <th style="width: 15%">
                                            Name
                                        </th>
                                        <th style="width: 5%">
                                            Rarity
                                        </th>
                                        <th style="width: 10%">
                                            Number
                                        </th>
                                        <th style="width: 35%">
                                            <div>Sell Price</div>
                                        </th>
                                        <th style="width: 35%">
                                            <div>Buy Price</div>
                                        </th>
                                    </tr>
                                </thead>

                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            }

            @if (Model.IngredientUsage != null && Model.IngredientUsage.IngredientUsageList.Count > 0)
            {
                <div class="tab-pane" id="ingredient" aria-labelledby="ingredient-tab">
                    <table id="ingredientUsageTable" class="table table-hover table-striped table-borderless">
                        <thead>
                            <tr>
                                <th>
                                    <loc model="loc" category="shared" name="tablehead.item">Item</loc>
                                </th>
                                <th>
                                    <loc model="loc" category="shared" name="tablehead.amount">Amount</loc>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.IngredientUsage.IngredientUsageList)
                            {
                                <tr>
                                    <td class="align-middle">
                                        <a href="~/item/@item.ItemId">
                                            @if (Model.Changes.ContainedItems[item.ItemId].ImageExists)
                                            {
                                                <img class="item-image-big" src="~/img/items/@(item.ItemId).png" />
                                            }
                                            else
                                            {
                                                <img class="item-image-big" src="~/img/NoImage.png" />
                                            }
                                        </a>
                                        <a href="~/item/@item.ItemId">@(Model.Changes.ContainedItems.ContainsKey(item.ItemId) == true ? Model.Changes.ContainedItems[item.ItemId].AvailableName : item.ItemId.ToString())</a>
                                    </td>
                                    <td class="align-middle">
                                        @item.Amount
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (false && Model.Item.Stats != null && Model.Item.Stats.SortedStats.Count > 0)
            {
                <div class="tab-pane" id="stats" aria-labelledby="stats-tab">

                    <div class="text-center alert-warning">
                        <loc model="loc" category="item" name="warning.stats">The stats are outdated and can't be updated anymore. Stats version</loc>: 0.9.135.91921
                    </div>

                    <table class="table table-hover table-striped table-borderless">
                        <thead>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Item.Stats.SortedStats)
                            {
                                if (item.DisplayValue && item.Stat.Type == Crossout.Data.StatType.Exposed)
                                {
                                    <tr>
                                        <td class="">@item.Stat.Name</td>
                                        <td><partial name="_stat" model="@item" /></td>
                                    </tr>
                                }
                            }
                            @foreach (var item in Model.Item.Stats.SortedStats)
                            {
                                if (item.DisplayValue && item.Stat.Type == Crossout.Data.StatType.Hidden)
                                {
                                    <tr>
                                        <td class="">@item.Stat.Name</td>
                                        <td><partial name="_stat" model="@item" /></td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (Model.Changes.Changes.Count > 0)
            {
                <div class="tab-pane" id="changes" aria-labelledby="changes-tab">
                    <partial name="changesmodular" model="@Model.Changes" />
                </div>
            }
        </div>
    </div>
</div>

<script src="~/scripts/internal/item.js?@(CacheBuster.Once)"></script>
<script src="~/scripts/internal/craftingcalc.js?@(CacheBuster.Once)"></script>
<script src="~/scripts/internal/synergy.js?@(CacheBuster.Once)"></script>
<script src="~/scripts/internal/scriptlocalization.js?@(CacheBuster.Once)"></script>
<script>
    $(document).ready(function () {
        adjustTimeStamp();
    });

    if (readSetting('full-size-item-tabs'))
        $('#itemTabsWrapper').removeClass('half-hd-container');

    $.getJSON(location.origin + '/data/recipe/@(Model.Item.Id)?l=' + Cookies.get('language'),
        async function (data) {
            recipeData.data = data;
            recipeData.loaded = true;

            $(".item-0").removeClass("disabled");

            craftingCalcData.data = data;
            craftingCalcData.loaded = true;

            await getLocalizations('item', Cookies.get('language'));
        });

    function onLocalizationLoaded() {
        localize();
        onDataLoaded();
    }

    $('#versionSelect').on('change', function (e) {
        $('.stats-version').addClass('d-none');
        let target = '#' + e.target.value;
        $(target).removeClass('d-none');
    })

    $.ajax({
        url: '/data/synergy/@(Model.Item.Id)',
        dataType: 'json',
        success: function (json) {
            synergyData.data = json;
            synergyData.loaded = true;
            onSynergyDataLoaded();
        }
    });

</script>
